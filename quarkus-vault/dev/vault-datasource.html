<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using HashiCorp Vault with Databases :: Quarkiverse Documentation</title>
    <link rel="canonical" href="https://quarkiverse.github.io/quarkiverse-docs/quarkus-vault/dev/vault-datasource.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/site-extra.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script>var uiRootPath = '../../_'</script>
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <a href="../..">Quarkiverse</a>
        <span class="separator">//</span>
        <a href="https://quarkiverse.github.io/quarkiverse-docs">Docs</a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Projects</div>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Index</a>
            <a class="navbar-item" href="#">Quarkus - Java Embedded Framework</a>
            <a class="navbar-item" href="#">Quarkus Amazon Alexa</a>
            <a class="navbar-item" href="#">Quarkus Amazon Services</a>
            <a class="navbar-item" href="#">Quarkus Artemis</a>
            <a class="navbar-item" href="#">Quarkus Config Extensions</a>
            <a class="navbar-item" href="#">Quarkus Cucumber</a>
            <a class="navbar-item" href="#">Quarkus CXF</a>
            <a class="navbar-item" href="#">Quarkus Dapr</a>
            <a class="navbar-item" href="#">Quarkus File Vault</a>
            <a class="navbar-item" href="#">Quarkus Freemarker</a>
            <a class="navbar-item" href="#">Quarkus GitHub Action</a>
            <a class="navbar-item" href="#">Quarkus GitHub App</a>
            <a class="navbar-item" href="#">Quarkus Google Cloud Services</a>
            <a class="navbar-item" href="#">Quarkus Helm</a>
            <a class="navbar-item" href="#">Quarkus Hibernate Search Extras</a>
            <a class="navbar-item" href="#">Quarkus Hibernate types</a>
            <a class="navbar-item" href="#">Quarkus HiveMQ Client</a>
            <a class="navbar-item" href="#">Quarkus JDBC Sqlite</a>
            <a class="navbar-item" href="#">Quarkus JGit</a>
            <a class="navbar-item" href="#">Quarkus JGraphT</a>
            <a class="navbar-item" href="#">Quarkus JSch</a>
            <a class="navbar-item" href="#">Quarkus Kerberos</a>
            <a class="navbar-item" href="#">Quarkus Logging JSON</a>
            <a class="navbar-item" href="#">Quarkus Logging Logback</a>
            <a class="navbar-item" href="#">Quarkus Logging Sentry</a>
            <a class="navbar-item" href="#">Quarkus Logging Splunk</a>
            <a class="navbar-item" href="#">Quarkus Micrometer Registry extensions</a>
            <a class="navbar-item" href="#">Quarkus Mockk</a>
            <a class="navbar-item" href="#">Quarkus MyBatis</a>
            <a class="navbar-item" href="#">Quarkus Neo4j</a>
            <a class="navbar-item" href="#">Quarkus Operator SDK</a>
            <a class="navbar-item" href="#">Quarkus Prettytime</a>
            <a class="navbar-item" href="#">Quarkus Quinoa</a>
            <a class="navbar-item" href="#">Quarkus RabbitMQ Client</a>
            <a class="navbar-item" href="#">Quarkus Reactive Messaging HTTP</a>
            <a class="navbar-item" href="#">Quarkus Renarde</a>
            <a class="navbar-item" href="#">Quarkus Tika</a>
            <a class="navbar-item" href="#">Quarkus Unleash</a>
            <a class="navbar-item" href="#">Quarkus Vault</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <div class="navbar-link">Community</div>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://quarkusio.zulipchat.com">Chat</a>
          </div>
        </div>
        <a class="navbar-item" href="https://twitter.com/quarkusio">
          <span class="icon">
            <svg aria-hidden="true" data-icon="twitter" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
              <path fill="#57aaee" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path>
            </svg>
          </span>
        </a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="quarkus-vault" data-version="dev">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Quarkus Vault</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Quarkus Vault</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="vault-auth.html">Vault Authentication guide</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="vault-transit.html">Vault Transit Secret Engine Guide</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="vault-pki.html">Vault PKI Secret Engine Guide</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="vault-datasource.html">Vault Datasource Guide</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Quarkus Vault</span>
    <span class="version">dev</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../index/index/index.html">Index</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../index/index/index.html">index</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-java-embedded-framework/dev/index.html">Quarkus - Java Embedded Framework</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-java-embedded-framework/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-amazon-alexa/dev/index.html">Quarkus Amazon Alexa</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-amazon-alexa/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-amazon-services/dev/index.html">Quarkus Amazon Services</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-amazon-services/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-artemis/dev/index.html">Quarkus Artemis</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-artemis/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-config-extensions/dev/index.html">Quarkus Config Extensions</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-config-extensions/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-cucumber/dev/index.html">Quarkus Cucumber</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-cucumber/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-cxf/dev/index.html">Quarkus CXF</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-cxf/dev/index.html">dev</a>
        </li>
        <li class="version">
          <a href="../../quarkus-cxf/v1.x/index.html">v1.x</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-dapr/dev/index.html">Quarkus Dapr</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-dapr/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-file-vault/dev/index.html">Quarkus File Vault</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-file-vault/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-freemarker/dev/index.html">Quarkus Freemarker</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-freemarker/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-github-action/dev/index.html">Quarkus GitHub Action</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-github-action/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-github-app/dev/index.html">Quarkus GitHub App</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-github-app/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-google-cloud-services/main/index.html">Quarkus Google Cloud Services</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-google-cloud-services/main/index.html">main</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-helm/dev/index.html">Quarkus Helm</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-helm/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-hibernate-search-extras/dev/index.html">Quarkus Hibernate Search Extras</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-hibernate-search-extras/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-hibernate-types/dev/index.html">Quarkus Hibernate types</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-hibernate-types/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-hivemq-client/dev/index.html">Quarkus HiveMQ Client</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-hivemq-client/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-JDBC-Sqlite/dev/index.html">Quarkus JDBC Sqlite</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-JDBC-Sqlite/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-jgit/dev/index.html">Quarkus JGit</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-jgit/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-jgrapht/dev/index.html">Quarkus JGraphT</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-jgrapht/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-jsch/dev/index.html">Quarkus JSch</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-jsch/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-kerberos/dev/index.html">Quarkus Kerberos</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-kerberos/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-logging-json/dev/index.html">Quarkus Logging JSON</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-logging-json/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-logging-logback/dev/index.html">Quarkus Logging Logback</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-logging-logback/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-logging-sentry/dev/index.html">Quarkus Logging Sentry</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-logging-sentry/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-logging-splunk/dev/index.html">Quarkus Logging Splunk</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-logging-splunk/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-micrometer-registry/dev/index.html">Quarkus Micrometer Registry extensions</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-micrometer-registry/dev/index.html">dev</a>
        </li>
        <li class="version">
          <a href="../../quarkus-micrometer-registry/1.x/index.html">1.x</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-mockk/dev/index.html">Quarkus Mockk</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-mockk/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-mybatis/dev/index.html">Quarkus MyBatis</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-mybatis/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-neo4j/dev/index.html">Quarkus Neo4j</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-neo4j/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-operator-sdk/dev/index.html">Quarkus Operator SDK</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-operator-sdk/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-prettytime/dev/index.html">Quarkus Prettytime</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-prettytime/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-quinoa/dev/index.html">Quarkus Quinoa</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-quinoa/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-rabbitmq-client/0.1.0/index.html">Quarkus RabbitMQ Client</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-rabbitmq-client/0.1.0/index.html">0.1.0</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-reactive-messaging-http/dev/index.html">Quarkus Reactive Messaging HTTP</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-reactive-messaging-http/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-renarde/dev/index.html">Quarkus Renarde</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-renarde/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-tika/dev/index.html">Quarkus Tika</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-tika/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../quarkus-unleash/dev/index.html">Quarkus Unleash</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../quarkus-unleash/dev/index.html">dev</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">Quarkus Vault</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">dev</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index/index/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Quarkus Vault</a></li>
    <li><a href="vault-datasource.html">Vault Datasource Guide</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/quarkiverse/quarkus-vault/edit/main/docs/modules/ROOT/pages/vault-datasource.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Using HashiCorp Vault with Databases</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The most common use case when working with Vault is to keep confidential the database connection credentials.
There are several approaches that are supported in Quarkus, with different levels of sophistication
and security:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Property fetched from the KV Secret Engine using the Vault MicroProfile Config Source</p>
</li>
<li>
<p>Quarkus Credentials Provider</p>
</li>
<li>
<p>Vault Dynamic DB Credentials</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This guide aims at providing examples for each of those approaches. We will reuse the application implemented
in the <a href="#vault.adoc" class="xref unresolved">Vault guide</a> and enhance it with a simple persistence use case.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To complete this guide, you need:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to complete the <a href="#vault.adoc" class="xref unresolved">Vault guide</a></p>
</li>
<li>
<p>roughly 20 minutes</p>
</li>
<li>
<p>an IDE</p>
</li>
<li>
<p>JDK 11+ installed with <code>JAVA_HOME</code> configured appropriately</p>
</li>
<li>
<p>Apache Maven 3.8.1+</p>
</li>
<li>
<p>Docker installed</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_application"><a class="anchor" href="#_application"></a>Application</h3>
<div class="paragraph">
<p>We assume the <a href="#vault.adoc" class="xref unresolved">Vault guide</a> application has been developed, a Vault container is running, and the root token is known.
In this section we are going to start a PostgreSQL database, and add a persistence service in the application.</p>
</div>
<div class="paragraph">
<p>Add the <em>Hibernate</em> and <em>PostgreSQL</em> extensions to the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>mvn quarkus:add-extension -Dextensions="io.quarkus:quarkus-hibernate-orm,io.quarkus:quarkus-jdbc-postgresql"</pre>
</div>
</div>
<div class="paragraph">
<p>Create a simple service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@ApplicationScoped
public class SantaClausService {

    @Inject
    EntityManager em;

    @Transactional
    public List&lt;Gift&gt; getGifts() {
        return (List&lt;Gift&gt;) em.createQuery("select g from Gift g").getResultList();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With its <code>Gift</code> entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Gift {

    private Long id;
    private String name;

    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator="giftSeq")
    public Long getId() {
        return id;
    }

    public void setId(Long id) {
        this.id = id;
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, add a new endpoint in <code>GreetingResource</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Inject
SantaClausService santaClausService;

@GET
@Path("/gift-count")
@Produces(MediaType.TEXT_PLAIN)
public int geGiftCount() {
    return santaClausService.getGifts().size();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Start a PostgreSQL database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker run --ulimit memlock=-1:-1 -it --rm=true --memory-swappiness=0 --name postgres-quarkus-hibernate -e POSTGRES_USER=sarah -e POSTGRES_PASSWORD=connor -e POSTGRES_DB=mydatabase -p 5432:5432 postgres:10.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are ready to configure Vault and Quarkus to be able to connect to this database from the application.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vault_microprofile_config_source"><a class="anchor" href="#_vault_microprofile_config_source"></a>Vault MicroProfile Config Source</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The simplest approach is to write the database password in the KV secret engine under the path that is
fetched from the Vault Config Source.</p>
</div>
<div class="paragraph">
<p>Open a new shell, <code>docker exec</code> in the Vault container and set the root token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker exec -it dev-vault sh
export VAULT_TOKEN=s.5VUS8pte13RqekCB2fmMT3u2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add a <code>dbpassword</code> property in the <code>config</code> path of the KV secret engine, beside the original <code>a-private-key</code>
property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">vault kv put secret/myapps/vault-quickstart/config a-private-key=123456 dbpassword=connor</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the following configuration in Quarkus to use the value of property <code>dbpassword</code> as our database password:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># configure your datasource
quarkus.datasource.db-kind = postgresql
quarkus.datasource.username = sarah
quarkus.datasource.password = ${dbpassword}
quarkus.datasource.jdbc.url = jdbc:postgresql://localhost:5432/mydatabase

# drop and create the database at startup (use `update` to only update the schema)
quarkus.hibernate-orm.database.generation=drop-and-create</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compile and start the application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">./mvnw package
java -jar target/quarkus-app/quarkus-run.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Test it with the <code>gift-count</code> endpoint:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl http://localhost:8080/hello/gift-count</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">0</code></pre>
</div>
</div>
<div class="paragraph">
<p>This approach is certainly the simplest of all. It has also the big advantage of working with any subsystem
that requires a secret information in the configuration (i.e. not just <em>Agroal</em>).
The only drawback is that the password will never be fetched again from Vault after the initial property loading.
This means that if the db password was changed while running, the application would have to be restarted after
Vault has been updated with the new password.
This contrasts with the credentials provider approach, which fetches the password from Vault every time a connection
creation is attempted.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_credentials_provider"><a class="anchor" href="#_credentials_provider"></a>Credentials Provider</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this approach we introduce a new abstraction called the <em>Credentials Provider</em> that acts as an intermediary
component between the Agroal datasource and Vault. The additional configuration required is small, and it
has the major advantage of handling gracefully database password change while the application is running,
without any restart. Since all new connections go through the <em>Credentials Provider</em> to fetch their password,
we make sure we have a fresh value every time.</p>
</div>
<div class="paragraph">
<p>Create a new path (different than the <code>config</code> path) in Vault where the database password will be added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">vault kv put secret/myapps/vault-quickstart/db password=connor</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since we allowed read access on <code>secret/myapps/vault-quickstart/*</code> subpaths in the policy, there is nothing else
we have to do to allow the application to read it.</p>
</div>
<div class="paragraph">
<p>When fetching credentials from Vault that are intended to be used by the Agroal connection pool, we need
first to create a named Vault credentials provider in the application.properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.vault.credentials-provider.mydatabase.kv-path=myapps/vault-quickstart/db</code></pre>
</div>
</div>
<div class="paragraph">
<p>This defines a credentials provider <code>mydatabase</code> that will fetch the password from key <code>password</code>
at path <code>myapps/vault-quickstart/db</code>.</p>
</div>
<div class="paragraph">
<p>The credentials provider can now be used in the datasource configuration, in place of the <code>password</code>
property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># configure your datasource
quarkus.datasource.db-kind = postgresql
quarkus.datasource.username = sarah
quarkus.datasource.credentials-provider = mydatabase
quarkus.datasource.jdbc.url = jdbc:postgresql://localhost:5432/mydatabase</code></pre>
</div>
</div>
<div class="paragraph">
<p>Recompile, start and test the <code>gift-count</code> endpoint. You should see <code>0</code> again.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_dynamic_database_credentials"><a class="anchor" href="#_dynamic_database_credentials"></a>Dynamic Database Credentials</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The two previous approaches work well and are very popular. However they rely on a well known user configured
in the application (i.e. the database user), and the security comes from the confidentiality of the password.
If the password was stolen, we would have to change it in the database and in Vault. Regularly rotating passwords
is actually a very good practice to limit (in time) the impact of getting the password stolen.</p>
</div>
<div class="paragraph">
<p>A more sophisticated approach consists in letting Vault create and retire database accounts on a regular basis.
This is supported in Vault with the <a href="https://www.vaultproject.io/docs/secrets/databases">Database secret engine</a>. A number
of databases are supported, such as <a href="https://www.vaultproject.io/docs/secrets/databases/postgresql">PostgreSQL</a>.</p>
</div>
<div class="paragraph">
<p>First we need to enable the <code>database</code> secret engine, configure the <code>postgresql-database-plugin</code> and create
the database role <code>mydbrole</code> (replace <code>10.0.0.3</code> by the actual host that is running the PostgreSQL container;
for simplicity we disabled <em>TLS</em> between Vault and the PostgreSQL database):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">vault secrets enable database

vault write database/config/mydb \
    plugin_name=postgresql-database-plugin \
    allowed_roles=mydbrole \
    connection_url=postgresql://{{username}}:{{password}}@10.0.0.3:5432/mydatabase?sslmode=disable \
    username=sarah \
    password=connor

cat &lt;&lt;EOF &gt; vault-postgres-creation.sql
CREATE ROLE "{{name}}" WITH LOGIN PASSWORD '{{password}}' VALID UNTIL '{{expiration}}';
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO "{{name}}";
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public to "{{name}}";
EOF

vault write database/roles/mydbrole \
    db_name=mydb creation_statements=@vault-postgres-creation.sql \
    default_ttl=1h \
    max_ttl=24h \
    revocation_statements="ALTER ROLE \"{{name}}\" NOLOGIN;" \
    renew_statements="ALTER ROLE \"{{name}}\" VALID UNTIL '{{expiration}}';"</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For this use case, user <code>sarah</code> configured above needs to be a PostgreSQL super user with the capability
to create users.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then we need to give a read capability to the Quarkus application on path <code>database/creds/mydbrole</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF | vault policy write vault-quickstart-policy -
path "secret/data/myapps/vault-quickstart/*" {
  capabilities = ["read"]
}
path "database/creds/mydbrole" {
  capabilities = [ "read" ]
}
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that Vault knows how to create users in PostgreSQL, we just need to change the <code>mydatabase</code> credentials
provider to use  <code>credentials-role</code> &amp; <code>credentials-mount</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.vault.credentials-provider.mydatabase.credentials-role=mydbrole
quarkus.vault.credentials-provider.mydatabase.credentials-mount=database</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using <code>quarkus.hibernate-orm.database.generation=drop-create</code>, objects get created with the applicative
user. Since a user will be created every time the applications starts, database objects will be created
with the first created user, then we will attempt to drop them on the second run with a different user that
is not the owner. As expected this will fail. As a result, it is recommended to use
<code>quarkus.hibernate-orm.database.generation=update</code> in this section.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Recompile with <code>./mvnw package</code>, start and test the <code>gift-count</code> endpoint. You should see <code>0</code> again.</p>
</div>
<div class="paragraph">
<p>Notice in the logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">2020-04-22 14:29:48,522 DEBUG [io.qua.vau.run.VaultDbManager] (Agroal_682171661) generated mydbrole credentials: {leaseId: database/creds/mydbrole/L6PxoI68gZDeVPXP0RAA4c0a, renewable: true, leaseDuration: 60s, valid_until: Wed Apr 22 14:30:48 CEST 2020, username: v-userpass-mydbrole-HeOMJCmy9coEnO2my2AR-1587558588, password:***}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you connect to the PostgreSQL database, and list all users configured on <code>mydatabase</code>, you will see the
<code>sarah</code> super user, but also the technical users dynamically created by Vault:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>docker exec -it postgres-quarkus-hibernate bash
psql mydatabase sarah

mydatabase=# \du
                                                        List of roles
                      Role name                      |                         Attributes                         | Member of
-----------------------------------------------------+------------------------------------------------------------+-----------
 sarah                                               | Superuser, Create role, Create DB, Replication, Bypass RLS | {}
 v-userpass-mydbrole-HeOMJCmy9coEnO2my2AR-1587558588 | Password valid until 2020-04-22 12:30:53+00                | {}
 v-userpass-mydbrole-N2ITbBXxoqMQ3A3cZL88-1587558572 | Cannot login                                              +| {}
                                                     | Password valid until 2020-04-22 12:30:37+00                |</pre>
</div>
</div>
<div class="paragraph">
<p>As you can see 2 users have been created:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>v-userpass-mydbrole-N2ITbBXxoqMQ3A3cZL88-1587558572</code> that has expired, which was created while we were executing the tests.</p>
</li>
<li>
<p><code>v-userpass-mydbrole-HeOMJCmy9coEnO2my2AR-1587558588</code> that is valid until <code>12:30:53</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As expected, users have been created dynamically by Vault, with expiration dates, allowing a rotation to occur,
without breaking existing connections, allowing a greater level of security than the traditional
<em>password</em> based approaches.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright (C) 2020-2022 <a href="https://www.redhat.com">Red Hat</a> and individual contributors to <a href="https://github.com/quarkiverse/quarkiverse-docs">Quarkiverse</a>.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
  </body>
</html>
